---
title: Differential Analysis of Microarray Data 
author: "Jianhai/Zhang (zhang.jianhai@hotmail.com)"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`" 
output:
  html_document:
fontsize: 14pt
---



```{r setup, eval=T, message=F, warning=F}

# The framework requires "R/3.4.0".

setwd("~/microarray.practice/GSE14578")
library(affy); library(limma); library(ape); library(gplots); library(Category); 
library(GOstats); library(ath1121501cdf)
library(ath1121501.db, lib.loc="/rhome/jzhan067/R/x86_64-pc-linux-gnu-library/3.4")
library(AnnotationDbi, lib.loc="/rhome/jzhan067/R/x86_64-pc-linux-gnu-library/3.4")
# Modular analysis.
library(eisa); library(gcrma); library(GO.db); library(KEGG.db); library(xtable)

```

# 1. From raw data manipulation to Bayes statistics.

## 1.1 Import of cel files and raw data manipulation.
```{r data_manipulation, eval=T, message=F, warning=F}

# Import cel files and normalization.
if (file.exists("data")) { load("data") } else {

  data <- ReadAffy(celfile.path="GSE14578_RAW_cel")
  save(data, file = "data")

}

if (file.exists("probedata")) { load("probedata") } else {

  probedata <- data.frame(ID=probeNames(data), PM=pm(data), MM=mm(data))
  save(probedata, file = "probedata")

}

# Normalization.
if (file.exists("rma")) { load("rma") } else { 

  rma <- rma(data); save(rma, file = "rma") 

}

# Edit sample title.
sam.title <- system("zcat GSE14578_series_matrix.txt.gz | grep Sample_title", intern=TRUE)
sam.title.sep <- unlist(strsplit(sam.title, "\"\t\""))
sam.title.sep[1] <- "roottip_control_total_rep1"
sam.title.sep[99] <- "shoot_hypoxia_pKAT1_rep2"

pat <- c("roottip", "root", "shoot", "control", "hypoxia", "_rep.")
repl <- c("RT", "R", "S", "C", "H", "")

# Simplify sample names.
sam1 <- NULL
for (i in sam.title.sep) {

  for (j in 1:length(repl)) {
  
    i <- gsub(pat[j], repl[j], i)
  
  }

  sam1 <- c(sam1, i)

}

sam2 <- gsub(";", ".", sam1) # Make the sample names follow R syntax.
sam <- unique(sam2)

```

## 1.2 Design and contrast matrix.
```{r design_matrix, eval=T, message=F, warning=F}

# Generate levels for design matrix.
sam.rep <- table(sam2)[sam]
j <- 0; level <- NULL
for (i in 1:length(sam.rep)) {

  j <- j+1; level <- c(level, rep(j, sam.rep[[i]]))

}

design <- model.matrix(~ 0+factor(level))
colnames(design) <- sam

# Contrast matrix.
contr1 <- combn(sam, 2)
contr2 <- paste(contr1[1,], contr1[2,], sep="-")
con.ma <- makeContrasts(contrasts=contr2, levels=design)

```

## 1.3 Linear model fit and empirical Bayes tatistics for DE.
```{r fit_Bayes, eval=T, message=F, warning=F}
fit <- lmFit(rma, design)

fit.contr <- contrasts.fit(fit, con.ma)

eBa <- eBayes(fit.contr)

```

# 2. Extract cell specific genes with topTableF(): any pairwise comparison at one run.

## 2.1 F-test on all comparisons.
```{r F_test, eval=T, message=F, warning=F}

ttf <- topTableF(eBa, number=nrow(rma), genelist=fit$genes, adjust.method="BH",
sort.by="F", p.value=1)

# Separate up and dow DEGs in each comparison in two separate data frames.
contr.na <-colnames(ttf)[1:1035]
df.na.f <- NULL
for (i in contr.na) {
 
    up.f <- ttf[ttf[, i] > 1 & ttf$adj.P.Val < 0.01, c(i, "adj.P.Val")]
    dow.f <- ttf[ttf[, i] < -1 & ttf$adj.P.Val < 0.01, c(i, "adj.P.Val")]
    assign(paste0(i, "_up"), up.f); assign(paste0(i, "_dow"), dow.f) 
    df.na.f <- c(df.na.f, c(paste0(i, "_up"), paste0(i, "_dow")))
 
    # Separate control-control and hypoxia-hypoxia comparisons.
    df.con <- df.na.f[grep("_C_.*_C_", df.na.f)]
    df.hy <- df.na.f[grep("_H_.*_H_", df.na.f)]  

  }

```

## 2.2 Extract up and dow DEGs for each sample from above data frames.
```{r DEG_each_sample_ttf, eval=T, message=F, warning=F}

up.all <- dow.all <- NULL

# Control-control comparisons. 
sam.con <- sam[grep("_C_", sam)]
for (i in sam.con) {

  up.pro <- dow.pro <- NULL  

  # Extract all up DEGs.
  up1 <- df.con[grep(paste0(i, "\\.", ".*", "_up"), df.con)]
  up2 <- df.con[grep(paste0("\\.", i, "_dow"), df.con)]
  for (j in c(up1, up2)) {

    if (nrow(get(j))) { up.pro <- c(up.pro, rownames(get(j))) }

  }

  ta.pro <- table(up.pro); pro <- names(ta.pro[ta.pro==length(c(up1, up2))])
  assign(paste0(i, "_up_F"), pro); up.all <- c(up.all, paste0(i, "_up_F"))

  # Extract all down DEGs.
  dow1 <- df.con[grep(paste0(i, "\\.", ".*", "_dow"), df.con)]
  dow2 <- df.con[grep(paste0("\\.", i, "_up"), df.con)]
  for (j in c(dow1, dow2)) {

    if (nrow(get(j))) { dow.pro <- c(dow.pro, rownames(get(j))) }

  }

  ta.pro.dow <- table(dow.pro); 
  pro.dow <- names(ta.pro.dow[ta.pro.dow==length(c(dow1, dow2))])
  assign(paste0(i, "_dow_F"), pro.dow); dow.all <- c(dow.all, paste0(i, "_dow_F"))

}

# Hypoxia-hypoxia comparisons.
sam.hy <- sam[grep("_H_", sam)]

for (i in sam.hy) {

  up.pro.hy <- dow.pro.hy <- NULL  

  # Extract all up DEGs.
  up1 <- df.hy[grep(paste0(i, "\\.", ".*", "_up"), df.hy)]
  up2 <- df.hy[grep(paste0("\\.", i, "_dow"), df.hy)]
  for (j in c(up1, up2)) {

    if (nrow(get(j))) { up.pro.hy <- c(up.pro.hy, rownames(get(j))) }

  }

  ta.pro.hy <- table(up.pro.hy); 
  pro.hy <- names(ta.pro.hy[ta.pro.hy==length(c(up1, up2))])
  assign(paste0(i, "_up_F"), pro.hy); up.all <- c(up.all, paste0(i, "_up_F"))

  # Extract all dow DEGs.
  dow1 <- df.hy[grep(paste0(i, "\\.", ".*", "_dow"), df.hy)]
  dow2 <- df.hy[grep(paste0("\\.", i, "_up"), df.hy)]
  for (j in c(dow1, dow2)) {

    if (nrow(get(j))) { dow.pro.hy <- c(dow.pro.hy, rownames(get(j))) }

  }

  ta.pro.hy.dow <- table(dow.pro.hy); 
  pro.hy.dow <- names(ta.pro.hy.dow[ta.pro.hy.dow==length(c(dow1, dow2))])
  assign(paste0(i, "_dow_F"), pro.hy.dow); dow.all <- c(dow.all, paste0(i, "_dow_F"))

}

```

# 3. Extract cell specific genes via step-by-step pairwise
# comparison. Each sample compared to the rest.

## 3.1 Store all up/down DEGs in a nested list for each sample.
```{r DEG_each_sample_pairwise, eval=T, message=F, warning=F}
 
for (i in rownames(con.ma)) {

  # All comparisons of tissue X: X-other.
  coeff <- grep(paste0(i, "-"), colnames(con.ma)) 

  if (length(coeff) > 0) {
    con.coef.up <- paste0(colnames(con.ma)[coeff], "_", coeff, "_up")
    con.coef.dow <- paste0(colnames(con.ma)[coeff], "_", coeff, "_dow")
    names(con.coef.up) <- con.coef.up
    names(con.coef.dow) <- con.coef.dow

    for (j in 1:length(coeff)) {

      deg0 <- topTable(eBa, coef=coeff[j], adjust="fdr", sort.by="B", 
      number=50000)

      assign(con.coef.up[j], rownames(deg0[deg0$logFC > 1 & deg0$adj.P.Val 
      < 0.01, ]))
      assign(con.coef.dow[j], rownames(deg0[deg0$logFC < -1 & deg0$adj.P.Val 
      < 0.01, ]))
 
    }    

    assign(paste0(i, "_up"), sapply(con.coef.up, function(a) get(a), simplify=
    F, USE.NAMES=T))
    assign(paste0(i, "_dow"), sapply(con.coef.dow, function(a) get(a), 
    simplify=F, USE.NAMES=T))

  } else if (length(coeff) == 0) { assign(paste0(i, "_up"), NULL); assign(paste0(i, 
  "_dow"), NULL) }

  # All comparisons of tissue X: other-X.
  coeff1 <- grep(paste0("-", i), colnames(con.ma)) 

  if (length(coeff1) > 0) {
    con.coef.up1 <- paste0(colnames(con.ma)[coeff1], "_", coeff1, "_up")
    con.coef.dow1 <- paste0(colnames(con.ma)[coeff1], "_", coeff1, "_dow")
    names(con.coef.up1) <- con.coef.up1
    names(con.coef.dow1) <- con.coef.dow1

    for (k in 1:length(coeff1)) {

      deg1 <- topTable(eBa, coef=coeff1[k], adjust="fdr", sort.by="B", 
      number=50000)

      assign(con.coef.dow1[k], rownames(deg1[deg1$logFC > 1 & deg1$adj.P.Val 
      < 0.01, ]))
      assign(con.coef.up1[k], rownames(deg1[deg1$logFC < -1 & deg1$adj.P.Val 
      < 0.01, ]))

    } 

    assign(paste0(i, "_dow1"), sapply(con.coef.dow1, function(a) get(a), 
    simplify=F, USE.NAMES=T))
    assign(paste0(i, "_up1"), sapply(con.coef.up1, function(a) get(a), 
    simplify=F, USE.NAMES=T))

  } else if (length(coeff1) == 0) { assign(paste0(i, "_up1"), NULL); assign(paste0(i, 
  "_dow1"), NULL) }

  # Structure all DEGs in nested lists for each sample.
  assign(paste0(i, "_up_all"), c(get(paste0(i, "_up")), 
  get(paste0(i, "_up1")))) 
  assign(paste0(i, "_dow_all"), c(get(paste0(i, "_dow")), 
  get(paste0(i, "_dow1"))))
   
  assign(paste0(i, "_dow_all"), sapply(paste0(i, "_dow_all"), function(x) 
  list(get(x)), simplify=F, USE.NAMES=T))
  assign(paste0(i, "_up_all"), sapply(paste0(i, "_up_all"), function(x) 
  list(get(x)), simplify=F, USE.NAMES=T))

  assign(paste0(i, "_deg"), list(get(paste0(i, "_up_all")), get(paste0(i, 
  "_dow_all"))))

  # Extract all up/down DEGs of each sample, relative to all the rest of control and 
  # hypoxia. This is not used downstream. Only con-con and hy-hy comparisons are considered
  # downstream.
  ta.up <- table(unlist(get(paste0(i, "_up_all")))); ta.pro.up <- names(ta.up[ta.up==
  length(rownames(con.ma))-1])
  assign(paste0(i, "_up_pro"), ta.pro.up); ta.pro.up <- ta.up <- NULL 

  ta.dow <- table(unlist(get(paste0(i, "_dow_all")))); ta.pro.dow <- names(ta.dow[ta.dow==
  length(rownames(con.ma))-1])
  assign(paste0(i, "_dow_pro"), ta.pro.dow); ta.pro.dow <- ta.dow <- NULL


}

```
## 3.2 DEGs from comparisons among control or hypoxia.

```{r DEG_con-con, eval=T, message=F, warning=F}

# Con-Con up DEGs.
con.up.na <- NULL
for (l in rownames(con.ma)) {

  name <- names(get(paste0(l, "_up_all"))[[1]][[1]]); con.con <- name[grep(".*_C_.*-.*_C_.*",
  name)]

  if (length(con.con)) {

  con.con.all <- unlist(get(paste0(l, "_up_all"))[[1]][[1]][con.con]); 
  con.con.ta <- table(con.con.all)   
  con.pro <- names(con.con.ta[con.con.ta==length(con.con)])
  assign(paste0(l, "_up_con"), con.pro)
  con.up.na <- c(con.up.na, paste0(l, "_up_con"))

  }

}

# Hy-Hy up DEGs.
hy.up.na <- NULL
for (h in rownames(con.ma)) {

  name <- names(get(paste0(h, "_up_all"))[[1]][[1]]); hy.hy <- name[grep(".*_H_.*-.*_H_.*",
  name)]

  if (length(hy.hy)) {

  hy.hy.all <- unlist(get(paste0(h, "_up_all"))[[1]][[1]][hy.hy]); 
  hy.hy.ta <- table(hy.hy.all)   
  hy.pro <- names(hy.hy.ta[hy.hy.ta==length(hy.hy)])
  assign(paste0(h, "_up_hy"), hy.pro)
  hy.up.na <- c(hy.up.na, paste0(h, "_up_hy"))

  }

}

# Con-Con down DEGs.
con.dow.na <- NULL
for (a in rownames(con.ma)) {

  name <- names(get(paste0(a, "_dow_all"))[[1]][[1]]); con.con <- name[grep(".*_C_.*-.*_C_.*",
  name)]

  if (length(con.con)) {

  con.con.all <- unlist(get(paste0(a, "_dow_all"))[[1]][[1]][con.con]); 
  con.con.ta <- table(con.con.all)   
  con.pro <- names(con.con.ta[con.con.ta==length(con.con)])
  assign(paste0(a, "_dow_con"), con.pro)
  con.dow.na <- c(con.dow.na, paste0(a, "_dow_con"))

  }

}

# Hy-Hy down DEGs.
hy.dow.na <- NULL
for (b in rownames(con.ma)) {

  name <- names(get(paste0(b, "_dow_all"))[[1]][[1]]); hy.hy <- name[grep
  (".*_H_.*-.*_H_.*", name)]

  if (length(hy.hy)) {

  hy.hy.all <- unlist(get(paste0(b, "_dow_all"))[[1]][[1]][hy.hy]); 
  hy.hy.ta <- table(hy.hy.all)   
  hy.pro <- names(hy.hy.ta[hy.hy.ta==length(hy.hy)])
  assign(paste0(b, "_dow_hy"), hy.pro)
  hy.dow.na <- c(hy.dow.na, paste0(b, "_dow_hy"))

  }

}

```

# 4. Get the up/dow DEGs identified by both methods.
```{r DEG_overlapping, eval=T, message=F, warning=F}

deg.all.f <- c(up.all, dow.all)
deg.all <- c(con.up.na, con.dow.na, hy.up.na, hy.dow.na)

sor <- sub("(.*)_(con|hy)", "\\1", sort(deg.all))
sor.f <- sub("(.*)_F", "\\1", sort(deg.all.f))
deg.both <- NULL

if (all(sor.f == sor)) {

  for (i in 1:length(deg.all)) {

    both <- intersect(get(sort(deg.all.f)[i]), get(sort(deg.all)[i]))
    assign(paste0(sor.f[i], "_both"), both)

    # Store vector names of overlapping DEGs in "deg.both". 
    deg.both <- c(deg.both, paste0(sor.f[i], "_both"))

  }

}

```

# 5. Summary of DEGs by the two methods.
```{r DEG_summary, eval=T, message=F, warning=F}

df.sum <- data.frame(matrix(NA, nrow = nrow(con.ma), ncol = 9, dimnames = list(sort(
rownames(con.ma)), c("up.pairwise", "up.F", "up.both", "dow.pairwise", "dow.F", 
"dow.both", "all_pairwise", "all_F", "all_both"))))

deg.all.sum <- c(deg.all.f, deg.all, deg.both)
con0.sum <- rownames(df.sum)[grep("_C_", rownames(df.sum))]
hy0.sum <- rownames(df.sum)[grep("_H_", rownames(df.sum))] 

# All sample specific DEGs except for pairwise comparison.
for (i in rownames(df.sum)) {

    df.sum[i, "up.F"] <- length(get(deg.all.sum[grep(paste0(i, "_up_F"), 
    deg.all.sum)]))

    df.sum[i, "dow.F"] <- length(get(deg.all.sum[grep(paste0(i, "_dow_F"), 
    deg.all.sum)]))

    df.sum[i, "up.both"] <- length(get(deg.all.sum[grep(paste0(i, "_up_both"), 
    deg.all.sum)]))
  
    df.sum[i, "dow.both"] <- length(get(deg.all.sum[grep(paste0(i, "_dow_both"), 
    deg.all.sum)]))
 
}

# All control-sample-specific DEGs for pairwise comparison. 
for (i in con0.sum) {

    df.sum[i, "up.pairwise"] <- length(get(deg.all.sum[grep(paste0(i, "_up_con"), 
    deg.all.sum)]))
  
    df.sum[i, "dow.pairwise"] <- length(get(deg.all.sum[grep(paste0(i, "_dow_con"), 
    deg.all.sum)]))

}

# All hypoxia-sample-specific DEGs for pairwise comparison. 
for (i in hy0.sum) {

    df.sum[i, "up.pairwise"] <- length(get(deg.all.sum[grep(paste0(i, "_up_hy"), 
    deg.all.sum)]))
  
    df.sum[i, "dow.pairwise"] <- length(get(deg.all.sum[grep(paste0(i, "_dow_hy"), 
    deg.all.sum)]))

}

df.sum[, "all_pairwise"] <- rowSums(df.sum[, c("up.pairwise", "dow.pairwise")])
df.sum[, "all_F"] <- rowSums(df.sum[, c("up.F", "dow.F")]) 
df.sum[, "all_both"] <- rowSums(df.sum[, c("up.both", "dow.both")])
df.sum

```

# 6. Clustering of samples.
```{r sample_clustering, eval=T, message=F, warning=F}

d <- cor(2^exprs(rma), method="pearson")
hc <- hclust(dist(1-d))
plot.phylo(as.phylo(hc), type="p", edge.col=4, edge.width=2, show.node.label=TRUE, 
no.margin=T)

```

# 7. Heatmap of DEGs.
```{r DEG_heatmap, eval=T, message=F, warning=F}

# Extract all probes from all control DEGs and all hypoxia DEGs, respectively.
deg.pro.con <- deg.pro.hy <- NULL
con.inde <- grep("_C_", deg.both); hy.inde <- grep("_H_", deg.both) 
deg.pro.con <- c(deg.pro.con, sapply(con.inde, function(x) get(deg.both[x]), 
simplify=T, USE.NAMES=F))
deg.pro.hy <- c(deg.pro.hy, sapply(hy.inde, function(x) get(deg.both[x]), 
simplify=T, USE.NAMES=F))

hm.pro.con <- unlist(deg.pro.con); hm.pro.hy <- unlist(deg.pro.hy)

# Control heatmap.
if (length(hm.pro.con)) {

  deg.ma.con <- 2^exprs(rma)[hm.pro.con, grep(".*control.*", sam.title.sep)] 
  # palette <- colorRampPalette(c("red", "green"))(n =75)
  heatmap.2(deg.ma.con, main = "Cell specific DEGs: control", notecol=F, 
  density.info="none", trace="none", margins =c(12,9), scale="row", 
  col=redgreen(50), dendrogram="both")

}

# Hypoxia heatmap.
if (length(hm.pro.hy)) {

  deg.ma.hy <- 2^exprs(rma)[hm.pro.hy, grep(".*hypoxia.*", sam.title.sep)]
  heatmap.2(deg.ma.hy, main = "Cell specific DEGs: hypoxia", notecol=F, 
  density.info="none", trace="none", margins =c(12,9), scale="row", 
  col=redgreen(50), dendrogram="both")

}

```

# 8. GO analysis.
```{r DEG_GO, eval=T, message=F, warning=F}

for (i in rownames(con.ma)) {

  for (j in c("_up_both", "_dow_both")) {
    
    sam.pro <- get(paste0(i, j))  
    sam.gen <- na.omit(as.vector(unlist(mget(sam.pro, ath1121501ACCNUM, ifnotfound=NA))))
    affy.uni <- ls(ath1121501cdf)
    gen.uni <- na.omit(as.vector(unlist(mget(affy.uni, ath1121501ACCNUM, ifnotfound=NA))))
   
    if (length(sam.gen)) {

      par <- new("GOHyperGParams", geneIds=sam.gen, universeGeneIds=gen.uni,
                 annotation="ath1121501", ontology="MF", pvalueCutoff=0.5, conditional=F,
                 testDirection = "over")
      hgOver <- hyperGTest(par)
      summary(hgOver)[1:3, c(1,2,5:7)]
      htmlReport(hgOver, file = paste0("hyperGTest/", i, j, "_HGTest", ".html"))

      }

  }

}

```

# 9. Modular analysis.
```{r modular_analysis, eval=T, message=F, warning=F} 

# Read in all control samples for module analysis.
con.inde <- grep("control", sam.title.sep)
gsm <- list.files("GSE14578_RAW_cel")
con.mo <- gsm[con.inde]
data.mo <- ReadAffy(filenames = con.mo, celfile.path="GSE14578_RAW_cel")

pma <- mas5calls(data.mo)

if (file.exists("gc.nor")) { load("gc.nor") } else {

  gc.nor <- gcrma(data.mo, fast = F)
  save(gc.nor, file = "gc.nor")

}

gc.nor$cell_type <- sam2[con.inde]

sam2.con <- sam2[con.inde]
for (i in unique(sam2[con.inde])) {

  inde.tis <- grep(i, sam2.con)
  rep.no <- seq_along(inde.tis)
  sam2.con[inde.tis] <- paste0(i, "_rep", rep.no)

}

sampleNames(gc.nor) <- sam2.con

# Keep only probesets present in at least three samples.
ke.mo <- rowSums(exprs(pma) == "P") >= 3

ex.set <- gc.nor[ke.mo, ]

# Filter out probes not mapped to Entrez ids in "ath1121501ENTREZID".
pro.entr <- toTable(ath1121501ENTREZID)
inter.isa <- intersect(pro.entr[, "probe_id"], row.names(exprs(ex.set)))
ex.set.fil <- ex.set[inter.isa, ]

isa.nor <- ISANormalize(ex.set)

if (file.exists("mo")) { load("mo") } else {

  set.seed(123)
  mo <- ISA(ex.set.fil, flist = NA, thr.gene = 0.1,thr.cond = c(1, 2), no.seeds = 1000)
  save(mo, file = "mo")

}

# Samples contained in each module.
getNoSamples(mo)

# Get samples or scores of a specific module.
getSamples(mo, 2)[[1]]
ex.set.fil$cell_type[getSamples(mo, 2)[[1]]]
getSampleScores(mo, 2)

# Features contained in each module. 
getNoFeatures(mo)

# Plot the module.
sep <- c(which(!duplicated(isa.nor$cell_type))[-1] -1, ncol(isa.nor)) 
names(sep) <- isa.nor$cell_type[!duplicated(isa.nor$cell_type)]
colbar <- rainbow(length(sep))
col <- colbar[as.factor(isa.nor$cell_type)]
condPlot(mo, 2, isa.nor, sep = sep, col = col) 

```



# Session Information.
```{r sessionInfor, eval=T, message=F, warning=F}

sessionInfo()

```

# Reference.

1. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2764735/
2. https://www.bioconductor.org/packages/devel/bioc/vignettes/limma/inst/doc/usersguide.pdf
3. http://faculty.ucr.edu/~tgirke/HTML_Presentations/Manuals/Workshop_Dec_6_10_2012/
   Rmicroarray/arrayBasics.R




